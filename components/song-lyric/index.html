<polymer-element name="song-lyric">
   <template>
       <style>
           :host {
               font-size: 10px;
           }
           div {
               padding-bottom: 10px;
           }
       </style>
        <div>{{currentWord}}</div>
   </template>
    <script>
        Polymer('song-lyric', {
            lrc : {},
            ready : function() {
                var self = this
                FM.obs.on('SONG:UPDATE', function(song) {
                    self.fetchLrc(song)
                })

                FM.obs.on('TIME:UPDATE', function(playTime) {
                    var songId = FM.status.song.sid
                    var lines = self.lrc[songId]
                    if(!lines || !lines.length) {
                        self.currentWord = '暂无歌词'
                    } else {
                        for(i = 0; i<lines.length; i++) {
                            if(playTime < lines[i].time) {
                                self.currentWord = lines[i -1 < 0 ? 0 : i -1].word
                                return
                            }
                        }
                    }
                })
                self.fetchLrc(FM.status.song)
            },

            fetchLrc : function(song) {
                var self = this
                FM.appSDK.lyric({
                    song_id : song.sid
                }, function(err, lyric) {
                    if(err) return console.error(err)
                    lyric = lyric || ''
                    self.lrc[song.sid] = self.parseLrc(lyric)
                })
            },

            parseLrc : function(lrc) {
                var lines = []
                lrc.replace((/\[(\d+)\:(\d+?(\.)?\d+)\](.+)/g), function($0, m, s, dot, word) {
                    var time = parseInt(m)*60 + parseFloat(s)
                    lines.push({
                        time : time,
                        word : word
                    })
                })
                return lines
            }
        })
    </script>
</polymer-element>